{% extends "base.html" %}

{% block content %}
<!-- Banner -->
<div class="viral-banner">
  <p>üî• <strong>Free for now.</strong> Instant AI analysis. No login needed.</p>
</div>

<div class="workflow-container">
  <!-- Sample Result Cards -->
  <div class="sample-cards-section">
    <h2>See What You Can Do</h2>
    <div class="sample-cards-grid">
      <div class="sample-card">
        <h3>üìÑ Resume Analyzer</h3>
        <p>ATS Score: 85/100</p>
        <p>‚úÖ Well-structured | ‚ö†Ô∏è Add more keywords</p>
        <a href="/resume-analyzer" class="card-link">Try Now ‚Üí</a>
      </div>
      <div class="sample-card">
        <h3>üìä Business Docs</h3>
        <p>Invoice Analysis Complete</p>
        <p>‚úÖ 12 line items extracted | üí∞ Total: $5,240</p>
        <a href="/business-docs-ai" class="card-link">Try Now ‚Üí</a>
      </div>
      <div class="sample-card">
        <h3>üö¢ EDI Validator</h3>
        <p>BAPLIE Validated</p>
        <p>‚úÖ Format: BAPLIE | üì¶ 45 containers</p>
        <a href="/edi-validator" class="card-link">Try Now ‚Üí</a>
      </div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('resume')">Resume</button>
    <button class="tab-btn" onclick="switchTab('business')">Business Docs</button>
    <button class="tab-btn" onclick="switchTab('edi')">Logistics EDI</button>
    <button class="tab-btn" onclick="switchTab('website')">Website Analyzer</button>
  </div>

  <!-- Resume Tab -->
  <div id="resume-tab" class="tab-content active">
    <h2>üìÑ Resume Analyzer</h2>
    <p class="tab-description">Upload your resume to get ATS score, match with job descriptions, and get AI-powered improvements.</p>
    
    <button onclick="tryDemoResume()" class="demo-btn-large">‚ú® Try Example Resume</button>
    
    <div class="upload-section">
      <form id="resumeUploadForm" enctype="multipart/form-data">
        <label>Upload Resume:</label>
        <input type="file" id="resumeFile" accept=".pdf" />
        <button type="submit">Upload Resume</button>
      </form>
      
      <form id="jdUploadForm" enctype="multipart/form-data" style="margin-top: 15px;">
        <label>Upload Job Description (Optional):</label>
        <input type="file" id="jdFile" accept=".pdf" />
        <button type="submit">Upload JD</button>
      </form>
    </div>

    <div id="resumeStatus" class="status-message"></div>

    <div class="workflow-actions" id="resumeActions" style="display: none;">
      <button onclick="getATSScore()" class="workflow-btn">Get ATS Score</button>
      <button onclick="matchWithJD()" class="workflow-btn">Match with JD</button>
      <button onclick="getFullReport()" class="workflow-btn">Full Report</button>
      <button onclick="rewriteResume()" class="workflow-btn">Rewrite Resume</button>
      <button onclick="shareResult()" class="workflow-btn share">Share Result</button>
      <button onclick="copyResult()" class="workflow-btn copy">Copy Result</button>
    </div>

    <div id="resumeResults" class="results-section"></div>
  </div>

  <!-- Business Docs Tab -->
  <div id="business-tab" class="tab-content">
    <h2>üìä Business Documents</h2>
    <p class="tab-description">Analyze contracts, invoices, and business documents with AI workflows.</p>
    
    <button onclick="tryDemoBusiness()" class="demo-btn-large">‚ú® Analyze Sample Invoice</button>
    
    <div class="upload-section">
      <form id="businessUploadForm" enctype="multipart/form-data">
        <label>Upload Document:</label>
        <input type="file" id="businessFile" accept=".pdf" />
        <button type="submit">Upload</button>
      </form>
    </div>

    <div id="businessStatus" class="status-message"></div>

    <div class="workflow-actions" id="businessActions" style="display: none;">
      <button onclick="extractInsights()" class="workflow-btn">Extract Insights</button>
      <button onclick="generateActionItems()" class="workflow-btn">Action Items</button>
      <button onclick="createSummary()" class="workflow-btn">Create Summary</button>
      <button onclick="riskAnalysis()" class="workflow-btn">Risk Analysis</button>
      <button onclick="generateEmail()" class="workflow-btn">Email Draft</button>
      <button onclick="shareResult()" class="workflow-btn share">Share Result</button>
    </div>

    <div class="output-format-selector" style="margin-top: 15px;">
      <label>Export Format:</label>
      <select id="outputFormat">
        <option value="json">JSON</option>
        <option value="excel">Excel/CSV</option>
        <option value="email">Email</option>
        <option value="slack">Slack</option>
        <option value="teams">Teams</option>
      </select>
      <button onclick="exportData()" class="export-btn">Export</button>
    </div>

    <div id="businessResults" class="results-section"></div>
  </div>

  <!-- EDI Tab -->
  <div id="edi-tab" class="tab-content">
    <h2>üö¢ Logistics EDI Analyzer</h2>
    <p class="tab-description">Validate and analyze EDI documents (BAPLIE, MOVINS, COPRAR).</p>
    
    <button onclick="tryDemoEDI()" class="demo-btn-large">‚ú® Try Sample BAPLIE</button>
    
    <div class="upload-section">
      <form id="ediUploadForm" enctype="multipart/form-data">
        <label>Upload EDI Document:</label>
        <input type="file" id="ediFile" accept=".edi,.txt,.baplie,.movins,.coprar" />
        <button type="submit">Upload & Analyze</button>
      </form>
    </div>

    <div id="ediStatus" class="status-message"></div>
    <div id="ediResults" class="results-section"></div>
  </div>

  <!-- Website Tab -->
  <div id="website-tab" class="tab-content">
    <h2>üåê Website Analyzer</h2>
    <p class="tab-description">Analyze website content and extract insights.</p>
    
    <button onclick="tryDemoWebsite()" class="demo-btn-large">‚ú® Analyze aigpt.co.in</button>
    
    <form id="urlForm">
      <label>Enter Website URL:</label>
      <input type="url" id="urlInput" placeholder="https://example.com" />
      <button type="submit">Analyze Website</button>
    </form>

    <div id="websiteStatus" class="status-message"></div>

    <div class="workflow-actions" id="websiteActions" style="display: none;">
      <button onclick="extractInsights()" class="workflow-btn">Extract Insights</button>
      <button onclick="createSummary()" class="workflow-btn">Create Summary</button>
      <button onclick="shareResult()" class="workflow-btn share">Share Result</button>
    </div>

    <div id="websiteResults" class="results-section"></div>
  </div>
</div>

<script>
let currentFileId = "active";
let currentTab = "resume";

function switchTab(tabName) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  
  // Show selected tab
  document.getElementById(tabName + '-tab').classList.add('active');
  event.target.classList.add('active');
  currentTab = tabName;
}

// Resume Analyzer Functions
document.getElementById("resumeUploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData();
  formData.append("file", document.getElementById("resumeFile").files[0]);
  formData.append("file_id", "active");
  
  const res = await fetch("/api/upload-multi", { method: "POST", body: formData });
  const data = await res.json();
  document.getElementById("resumeStatus").innerText = data.message || data.error;
  if (data.message) document.getElementById("resumeActions").style.display = "block";
});

document.getElementById("jdUploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData();
  formData.append("file", document.getElementById("jdFile").files[0]);
  formData.append("file_id", "jd");
  
  const res = await fetch("/api/upload-multi", { method: "POST", body: formData });
  const data = await res.json();
  document.getElementById("resumeStatus").innerText += "\n" + (data.message || data.error);
});

async function getATSScore() {
  document.getElementById("resumeResults").innerHTML = '<div class="loading">‚è≥ Calculating ATS Score...</div>';
  try {
    const res = await fetch("/api/resume/ats-score", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    });
    const data = await res.json();
    displayResumeResults("resumeResults", data, "ats");
    document.getElementById("resumeResults").scrollIntoView({ behavior: 'smooth', block: 'start' });
  } catch (error) {
    document.getElementById("resumeResults").innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
  }
}

async function matchWithJD() {
  const res = await fetch("/api/resume/match-jd", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ jd_file_id: "jd" })
  });
  const data = await res.json();
  displayResults("resumeResults", data);
}

async function getFullReport() {
  document.getElementById("resumeResults").innerHTML = '<div class="loading">‚è≥ Generating full report...</div>';
  try {
    const res = await fetch("/api/resume/full-report", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ jd_file_id: "jd" })
    });
    const data = await res.json();
    displayResumeResults("resumeResults", data, "full");
    document.getElementById("resumeResults").scrollIntoView({ behavior: 'smooth', block: 'start' });
  } catch (error) {
    document.getElementById("resumeResults").innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
  }
}

async function rewriteResume() {
  const res = await fetch("/api/resume/rewrite", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ improvements: [] })
  });
  const data = await res.json();
  displayResults("resumeResults", data);
}

// Business Docs Functions
document.getElementById("businessUploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData();
  formData.append("file", document.getElementById("businessFile").files[0]);
  
  const res = await fetch("/upload", { method: "POST", body: formData });
  const data = await res.json();
  document.getElementById("businessStatus").innerText = data.message || data.error;
  if (data.message) document.getElementById("businessActions").style.display = "block";
});

async function extractInsights() {
  document.getElementById("businessResults").innerHTML = '<div class="loading">‚è≥ Extracting insights...</div>';
  try {
    const res = await fetch("/api/workflow/extract-insights", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ document_type: "business" })
    });
    const data = await res.json();
    displayBusinessResults("businessResults", data);
    document.getElementById("businessResults").scrollIntoView({ behavior: 'smooth', block: 'start' });
  } catch (error) {
    document.getElementById("businessResults").innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
  }
}

async function generateActionItems() {
  const res = await fetch("/api/workflow/action-items", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({})
  });
  const data = await res.json();
  displayResults("businessResults", data);
}

async function createSummary() {
  const res = await fetch("/api/workflow/summary", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ type: "executive" })
  });
  const data = await res.json();
  displayResults("businessResults", data);
}

async function riskAnalysis() {
  const res = await fetch("/api/workflow/risk-analysis", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({})
  });
  const data = await res.json();
  displayResults("businessResults", data);
}

async function generateEmail() {
  const res = await fetch("/api/workflow/email-draft", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ type: "summary" })
  });
  const data = await res.json();
  displayResults("businessResults", data);
}

// EDI Functions
document.getElementById("ediUploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const file = document.getElementById("ediFile").files[0];
  if (!file) {
    document.getElementById("ediStatus").innerText = "Please select a file";
    return;
  }
  
  const formData = new FormData();
  formData.append("file", file);
  
  document.getElementById("ediStatus").innerHTML = '<div class="loading">‚è≥ Analyzing EDI file...</div>';
  document.getElementById("ediResults").innerHTML = "";
  
  try {
    // Use new analyze-edi endpoint directly with file
    const res = await fetch("/api/analyze-edi", {
      method: "POST",
      body: formData
    });
    const data = await res.json();
    
    if (data.error) {
      document.getElementById("ediStatus").innerHTML = `<div class="error-message">‚ùå ${data.error}</div>`;
    } else {
      document.getElementById("ediStatus").innerHTML = '<div class="success-message">‚úÖ EDI file analyzed successfully!</div>';
      displayEDIResults("ediResults", data);
      // Auto-scroll to results
      document.getElementById("ediResults").scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  } catch (error) {
    document.getElementById("ediStatus").innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
  }
});

// Website Functions
document.getElementById("urlForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const url = document.getElementById("urlInput").value;
  if (!url) {
    document.getElementById("websiteStatus").innerHTML = '<div class="error-message">Please enter a URL</div>';
    return;
  }
  
  document.getElementById("websiteStatus").innerHTML = '<div class="loading">‚è≥ Analyzing website...</div>';
  document.getElementById("websiteResults").innerHTML = "";
  
  try {
    const res = await fetch("/api/analyze-website", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ url })
    });
    const data = await res.json();
    
    if (data.error) {
      document.getElementById("websiteStatus").innerHTML = `<div class="error-message">‚ùå ${data.error}</div>`;
    } else {
      document.getElementById("websiteStatus").innerHTML = '<div class="success-message">‚úÖ Website analyzed successfully!</div>';
      document.getElementById("websiteActions").style.display = "block";
      displayWebsiteResults("websiteResults", data);
      // Auto-scroll to results
      document.getElementById("websiteResults").scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  } catch (error) {
    document.getElementById("websiteStatus").innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
  }
});

// Demo Functions
async function tryDemoResume() {
  document.getElementById("resumeResults").innerHTML = '<div class="loading">‚è≥ Loading demo resume analysis...</div>';
  try {
    const res = await fetch("/api/demo/resume");
    const data = await res.json();
    displayResumeResults("resumeResults", data, "ats");
    document.getElementById("resumeResults").scrollIntoView({ behavior: 'smooth', block: 'start' });
  } catch (error) {
    document.getElementById("resumeResults").innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
  }
}

async function tryDemoBusiness() {
  const res = await fetch("/api/demo/business");
  const data = await res.json();
  displayResults("businessResults", data.sampleData);
}

async function tryDemoEDI() {
  document.getElementById("ediStatus").innerHTML = '<div class="loading">‚è≥ Loading demo EDI analysis...</div>';
  document.getElementById("ediResults").innerHTML = "";
  try {
    const res = await fetch("/api/demo/edi");
    const data = await res.json();
    displayEDIResults("ediResults", data);
    document.getElementById("ediStatus").innerHTML = '<div class="success-message">‚úÖ Demo EDI analysis loaded!</div>';
    document.getElementById("ediResults").scrollIntoView({ behavior: 'smooth', block: 'start' });
  } catch (error) {
    document.getElementById("ediStatus").innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
  }
}

async function tryDemoWebsite() {
  const url = "https://aigpt.co.in";
  document.getElementById("websiteStatus").innerHTML = '<div class="loading">‚è≥ Analyzing demo website...</div>';
  document.getElementById("websiteResults").innerHTML = "";
  
  try {
    const res = await fetch("/api/analyze-website", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ url })
    });
    const data = await res.json();
    
    if (data.error) {
      document.getElementById("websiteStatus").innerHTML = `<div class="error-message">‚ùå ${data.error}</div>`;
    } else {
      document.getElementById("websiteStatus").innerHTML = '<div class="success-message">‚úÖ Demo analysis complete!</div>';
      document.getElementById("websiteActions").style.display = "block";
      displayWebsiteResults("websiteResults", data);
    }
  } catch (error) {
    document.getElementById("websiteStatus").innerHTML = `<div class="error-message">‚ùå Error: ${error.message}</div>`;
  }
}

// Share Functions
function shareResult() {
  const shareUrl = window.location.href;
  if (navigator.share) {
    navigator.share({ title: "AI Document Analysis", url: shareUrl });
  } else {
    navigator.clipboard.writeText(shareUrl);
    alert("Link copied to clipboard!");
  }
}

function copyResult() {
  const results = document.querySelectorAll('.results-section pre');
  if (results.length > 0) {
    navigator.clipboard.writeText(results[0].innerText);
    alert("Results copied to clipboard!");
  }
}

// Utility Functions
function displayResults(containerId, data) {
  const container = document.getElementById(containerId);
  container.innerHTML = `<div class="result-card"><h3>Your Results</h3><pre class="result-json">${JSON.stringify(data, null, 2)}</pre><button onclick="copyResult()" class="copy-btn">üìã Copy Result</button></div>`;
}

function displayEDIResults(containerId, data) {
  const container = document.getElementById(containerId);
  let html = '<div class="result-card"><h3>üìä EDI Analysis Results</h3>';
  
  // Format Type
  html += `<div class="result-section"><h4>Format: ${data.formatType || 'Unknown'}</h4></div>`;
  
  // Validation Status
  const validation = data.validation || {};
  if (validation.isValid) {
    html += '<div class="result-section success-card"><h4>‚úÖ Validation: PASSED</h4></div>';
  } else {
    html += '<div class="result-section error-card"><h4>‚ùå Validation: FAILED</h4></div>';
  }
  
  // Errors
  if (validation.errors && validation.errors.length > 0) {
    html += '<div class="result-section error-card"><h4>‚ùå Errors:</h4><ul>';
    validation.errors.forEach(err => html += `<li>${err}</li>`);
    html += '</ul></div>';
  }
  
  // Warnings
  if (validation.warnings && validation.warnings.length > 0) {
    html += '<div class="result-section warning-card"><h4>‚ö†Ô∏è Warnings:</h4><ul>';
    validation.warnings.forEach(warn => html += `<li>${warn}</li>`);
    html += '</ul></div>';
  }
  
  // Summary
  if (data.summary) {
    html += `<div class="result-section"><h4>üìù Summary:</h4><p>${data.summary}</p></div>`;
  }
  
  // Containers
  if (validation.containersFound > 0) {
    html += `<div class="result-section"><h4>üì¶ Containers Found: ${validation.containersFound}</h4>`;
    if (validation.containerNumbers && validation.containerNumbers.length > 0) {
      html += '<ul>';
      validation.containerNumbers.forEach(cont => html += `<li>${cont}</li>`);
      html += '</ul>';
    }
    html += '</div>';
  }
  
  // Suggestions
  if (validation.suggestions && validation.suggestions.length > 0) {
    html += '<div class="result-section suggestion-card"><h4>üí° Suggestions:</h4><ul>';
    validation.suggestions.forEach(sugg => html += `<li>${sugg}</li>`);
    html += '</ul></div>';
  }
  
  // Full JSON (collapsible)
  html += `<details class="result-section"><summary>View Full JSON</summary><pre class="result-json">${JSON.stringify(data, null, 2)}</pre></details>`;
  html += '<button onclick="copyResult()" class="copy-btn">üìã Copy Result</button>';
  html += '</div>';
  
  container.innerHTML = html;
}

function displayResumeResults(containerId, data, type = "ats") {
  const container = document.getElementById(containerId);
  let html = '<div class="result-card"><h3>üìÑ Resume Analysis Results</h3>';
  
  if (type === "full") {
    // Full Report
    const atsScore = data.atsScore || {};
    const overallScore = atsScore.overallScore || 0;
    
    html += `<div class="result-section success-card"><h4>üéØ Overall ATS Score: <span class="score-badge">${overallScore}/100</span></h4></div>`;
    
    // Strengths
    if (atsScore.strengths && atsScore.strengths.length > 0) {
      html += '<div class="result-section suggestion-card"><h4>‚úÖ Strengths:</h4><ul>';
      atsScore.strengths.forEach(str => html += `<li>${str}</li>`);
      html += '</ul></div>';
    }
    
    // Weaknesses
    if (atsScore.weaknesses && atsScore.weaknesses.length > 0) {
      html += '<div class="result-section error-card"><h4>‚ö†Ô∏è Weaknesses:</h4><ul>';
      atsScore.weaknesses.forEach(weak => html += `<li>${weak}</li>`);
      html += '</ul></div>';
    }
    
    // Recommendations
    if (atsScore.recommendations && atsScore.recommendations.length > 0) {
      html += '<div class="result-section suggestion-card"><h4>üí° Recommendations:</h4><ul>';
      atsScore.recommendations.forEach(rec => html += `<li>${rec}</li>`);
      html += '</ul></div>';
    }
    
    // Skill Gaps
    if (data.skillGaps && data.skillGaps.missingSkills && data.skillGaps.missingSkills.length > 0) {
      html += '<div class="result-section warning-card"><h4>üìä Missing Skills:</h4><ul>';
      data.skillGaps.missingSkills.forEach(skill => html += `<li>${skill}</li>`);
      html += '</ul></div>';
    }
    
    // Summary
    if (data.summary) {
      html += `<div class="result-section"><h4>üìù Executive Summary:</h4><p>${data.summary}</p></div>`;
    }
  } else {
    // ATS Score only
    const overallScore = data.overallScore || 0;
    html += `<div class="result-section success-card"><h4>üéØ ATS Score: <span class="score-badge">${overallScore}/100</span></h4></div>`;
    
    if (data.strengths && data.strengths.length > 0) {
      html += '<div class="result-section suggestion-card"><h4>‚úÖ Strengths:</h4><ul>';
      data.strengths.forEach(str => html += `<li>${str}</li>`);
      html += '</ul></div>';
    }
    
    if (data.weaknesses && data.weaknesses.length > 0) {
      html += '<div class="result-section error-card"><h4>‚ö†Ô∏è Weaknesses:</h4><ul>';
      data.weaknesses.forEach(weak => html += `<li>${weak}</li>`);
      html += '</ul></div>';
    }
  }
  
  // Full JSON (collapsible)
  html += `<details class="result-section"><summary>View Full JSON</summary><pre class="result-json">${JSON.stringify(data, null, 2)}</pre></details>`;
  html += '<button onclick="copyResult()" class="copy-btn">üìã Copy Result</button>';
  html += '</div>';
  
  container.innerHTML = html;
}

function displayBusinessResults(containerId, data) {
  const container = document.getElementById(containerId);
  let html = '<div class="result-card"><h3>üìä Business Document Analysis</h3>';
  
  // Summary
  if (data.summary) {
    html += `<div class="result-section"><h4>üìù Summary:</h4><p>${data.summary}</p></div>`;
  }
  
  // Document Type
  if (data.documentType) {
    html += `<div class="result-section"><h4>üìÑ Document Type:</h4><p>${data.documentType}</p></div>`;
  }
  
  // Key Insights
  if (data.insights && data.insights.keyInsights) {
    html += '<div class="result-section suggestion-card"><h4>üí° Key Insights:</h4><ul>';
    data.insights.keyInsights.forEach(insight => html += `<li>${insight}</li>`);
    html += '</ul></div>';
  }
  
  // Risks
  if (data.risks && data.risks.length > 0) {
    html += '<div class="result-section error-card"><h4>‚ö†Ô∏è Risks & Red Flags:</h4><ul>';
    data.risks.forEach(risk => html += `<li>${risk}</li>`);
    html += '</ul></div>';
  }
  
  // Action Items
  if (data.actionItems && data.actionItems.length > 0) {
    html += '<div class="result-section suggestion-card"><h4>‚úÖ Action Items:</h4><ul>';
    data.actionItems.forEach(item => html += `<li>${item}</li>`);
    html += '</ul></div>';
  }
  
  // Tables
  if (data.tables && data.tables.length > 0) {
    html += '<div class="result-section"><h4>üìã Extracted Tables:</h4>';
    data.tables.forEach((table, idx) => {
      html += `<div style="margin-top: 1rem;"><strong>${table.tableName || `Table ${idx + 1}`}</strong>`;
      if (table.totalAmount) {
        html += ` - Total: ${table.currency || '$'}${table.totalAmount}`;
      }
      html += '</div>';
    });
    html += '</div>';
  }
  
  // Full JSON (collapsible)
  html += `<details class="result-section"><summary>View Full JSON</summary><pre class="result-json">${JSON.stringify(data, null, 2)}</pre></details>`;
  html += '<button onclick="copyResult()" class="copy-btn">üìã Copy Result</button>';
  html += '</div>';
  
  container.innerHTML = html;
}

function displayWebsiteResults(containerId, data) {
  const container = document.getElementById(containerId);
  let html = '<div class="result-card"><h3>üåê Website Analysis Results</h3>';
  
  // SEO Score
  const seoAnalysis = data.seoAnalysis || {};
  const seoScore = seoAnalysis.seoScore || 0;
  html += `<div class="result-section"><h4>SEO Score: <span class="score-badge">${seoScore}/100</span></h4></div>`;
  
  // Title
  if (data.websiteData && data.websiteData.title) {
    html += `<div class="result-section"><h4>üìÑ Title:</h4><p>${data.websiteData.title}</p></div>`;
  }
  
  // Meta Description
  if (data.websiteData && data.websiteData.metaDescription) {
    html += `<div class="result-section"><h4>üìù Meta Description:</h4><p>${data.websiteData.metaDescription}</p></div>`;
  }
  
  // Structure
  const structure = data.structure || {};
  html += `<div class="result-section"><h4>üìä Page Structure:</h4><ul>`;
  html += `<li>H1 Tags: ${structure.h1Count || 0}</li>`;
  html += `<li>H2 Tags: ${structure.h2Count || 0}</li>`;
  html += `<li>H3 Tags: ${structure.h3Count || 0}</li>`;
  html += `<li>Links: ${structure.linkCount || 0}</li>`;
  html += `<li>Images: ${structure.imageCount || 0}</li>`;
  html += '</ul></div>';
  
  // Issues
  if (data.issues && data.issues.length > 0) {
    html += '<div class="result-section error-card"><h4>‚ùå Issues:</h4><ul>';
    data.issues.forEach(issue => html += `<li>${issue}</li>`);
    html += '</ul></div>';
  }
  
  // Opportunities
  if (data.opportunities && data.opportunities.length > 0) {
    html += '<div class="result-section suggestion-card"><h4>üí° Opportunities:</h4><ul>';
    data.opportunities.forEach(opp => html += `<li>${opp}</li>`);
    html += '</ul></div>';
  }
  
  // Recommendations
  if (data.recommendations && data.recommendations.length > 0) {
    html += '<div class="result-section suggestion-card"><h4>‚úÖ Recommendations:</h4><ul>';
    data.recommendations.forEach(rec => html += `<li>${rec}</li>`);
    html += '</ul></div>';
  }
  
  // Keywords
  if (data.keywords && data.keywords.length > 0) {
    html += '<div class="result-section"><h4>üîë Keywords:</h4><ul>';
    data.keywords.slice(0, 10).forEach(kw => html += `<li>${kw}</li>`);
    html += '</ul></div>';
  }
  
  // Full JSON (collapsible)
  html += `<details class="result-section"><summary>View Full JSON</summary><pre class="result-json">${JSON.stringify(data, null, 2)}</pre></details>`;
  html += '<button onclick="copyResult()" class="copy-btn">üìã Copy Result</button>';
  html += '</div>';
  
  container.innerHTML = html;
}

async function exportData() {
  const format = document.getElementById("outputFormat").value;
  const results = document.getElementById("businessResults").innerText;
  
  const res = await fetch(`/api/export/${format}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ data: JSON.parse(results || "{}") })
  });
  
  if (format === "json" || format === "excel") {
    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `export.${format === "json" ? "json" : "csv"}`;
    a.click();
  } else {
    const data = await res.json();
    alert(`Export ready! Check console for ${format} format.`);
    console.log(data);
  }
}
</script>
{% endblock %}

