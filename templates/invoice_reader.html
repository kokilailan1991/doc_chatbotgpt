{% extends "base.html" %}

{% block content %}
<div class="main-content-wrapper">
  <div class="tool-header">
    <h1 class="tool-title">üìä Invoice Reader AI</h1>
    <p class="tool-subtitle">Extract invoice data automatically: items, quantities, prices, taxes, and totals. Export to CSV.</p>
  </div>

  <button onclick="trySampleInvoice()" class="demo-btn-large">‚ú® Try Sample Invoice</button>

  <div class="upload-card">
    <h3 class="upload-header">Upload Invoice</h3>
    <form id="invoiceUploadForm" enctype="multipart/form-data">
      <label class="upload-label">Select Invoice (PDF/Image/Text):</label>
      <input type="file" id="invoiceFile" accept=".pdf,.png,.jpg,.jpeg,.txt" class="file-input" />
      <button type="submit" class="upload-btn">Upload & Extract</button>
    </form>
    
    <div class="sample-links">
      <a href="#" onclick="trySampleInvoice(); return false;">Try Sample Invoice</a>
    </div>
  </div>

  <div id="invoiceStatus" class="status-message"></div>

  <div class="workflow-actions" id="invoiceActions" style="display: none;">
    <button onclick="extractInvoice()" class="workflow-btn">Extract Data</button>
    <button onclick="exportCSV()" class="workflow-btn">Export CSV</button>
    <button onclick="shareResult()" class="workflow-btn share">Share Result</button>
    <button onclick="copyResult()" class="workflow-btn copy">Copy Result</button>
  </div>

  <div id="invoiceResults" class="results-section"></div>
</div>

<script>
let invoiceData = null;

document.getElementById("invoiceUploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const file = document.getElementById("invoiceFile").files[0];
  if (!file) {
    document.getElementById("invoiceStatus").innerHTML = '<div class="error-message">Please select a file</div>';
    return;
  }
  
  const formData = new FormData();
  formData.append("file", file);
  
  document.getElementById("invoiceStatus").innerHTML = '<div class="loading">‚è≥ Processing invoice...</div>';
  
  try {
    const res = await fetch("/upload", { method: "POST", body: formData });
    
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}: ${res.statusText}` }));
      document.getElementById("invoiceStatus").innerHTML = '<div class="error-message">‚ùå ' + (errorData.error || `Server error: ${res.status}`) + '</div>';
      return;
    }
    
    const data = await res.json();
    
    if (data.error) {
      document.getElementById("invoiceStatus").innerHTML = '<div class="error-message">‚ùå ' + data.error + '</div>';
    } else if (data.message) {
      document.getElementById("invoiceStatus").innerHTML = '<div class="success-message">‚úÖ ' + data.message + '</div>';
      document.getElementById("invoiceActions").style.display = "flex";
    } else {
      document.getElementById("invoiceStatus").innerHTML = '<div class="error-message">‚ùå Unexpected response format</div>';
    }
  } catch (error) {
    document.getElementById("invoiceStatus").innerHTML = '<div class="error-message">‚ùå Error: ' + error.message + '</div>';
  }
});

async function extractInvoice() {
  document.getElementById("invoiceResults").innerHTML = '<div class="loading">‚è≥ Extracting invoice data...</div>';
  try {
    const res = await fetch("/api/business-docs/analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    });
    
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}: ${res.statusText}` }));
      throw new Error(errorData.error || `Server error: ${res.status}`);
    }
    
    const data = await res.json();
    
    if (data.error) {
      document.getElementById("invoiceResults").innerHTML = '<div class="error-message">‚ùå ' + data.error + '</div>';
      return;
    }
    
    invoiceData = data;
    displayInvoiceResults("invoiceResults", data);
    document.getElementById("invoiceResults").scrollIntoView({ behavior: 'smooth' });
  } catch (error) {
    document.getElementById("invoiceResults").innerHTML = '<div class="error-message">‚ùå Error: ' + error.message + '</div>';
  }
}

async function trySampleInvoice() {
  invoiceData = {
    documentType: "Invoice",
    summary: "Sample invoice from ABC Company dated January 2024",
    tables: [{
      tableName: "Line Items",
      headers: ["Item", "Quantity", "Price", "Total"],
      rows: [
        { Item: "Product A", Quantity: "10", Price: "$50.00", Total: "$500.00" },
        { Item: "Product B", Quantity: "5", Price: "$30.00", Total: "$150.00" }
      ],
      totalAmount: "$650.00",
      currency: "$"
    }],
    risks: [],
    actionItems: ["Verify all line items", "Check payment terms"]
  };
  displayInvoiceResults("invoiceResults", invoiceData);
  document.getElementById("invoiceStatus").innerHTML = '<div class="success-message">‚úÖ Sample invoice loaded!</div>';
  document.getElementById("invoiceActions").style.display = "flex";
}

function displayInvoiceResults(containerId, data) {
  const container = document.getElementById(containerId);
  
  // Check for errors first
  if (data.error) {
    container.innerHTML = '<div class="error-message">‚ùå ' + data.error + '</div>';
    return;
  }
  
  let html = '<div class="result-card fade-in"><h3 class="result-header">üìä Invoice Analysis</h3>';
  
  if (data.summary) {
    html += '<div class="result-section"><h4>üìù Summary:</h4><p>' + data.summary + '</p></div>';
  }
  
  if (data.tables && data.tables.length > 0) {
    data.tables.forEach((table, idx) => {
      html += '<div class="result-section"><h4>üìã ' + (table.tableName || 'Table ' + (idx + 1)) + ':</h4>';
      if (table.headers && table.rows) {
        html += '<table class="invoice-table"><thead><tr>';
        table.headers.forEach(h => html += '<th>' + h + '</th>');
        html += '</tr></thead><tbody>';
        table.rows.forEach(row => {
          html += '<tr>';
          table.headers.forEach(h => html += '<td>' + (row[h] || '') + '</td>');
          html += '</tr>';
        });
        html += '</tbody></table>';
      }
      if (table.totalAmount) {
        html += '<p class="invoice-total"><strong>Total: ' + (table.currency || '$') + table.totalAmount + '</strong></p>';
      }
      html += '</div>';
    });
  }
  
  if (data.risks && data.risks.length > 0) {
    html += '<div class="result-section error-card"><h4>‚ö†Ô∏è Suspicious Charges:</h4><ul>';
    data.risks.forEach(risk => {
      if (typeof risk === 'object' && risk !== null) {
        // Handle object format with title, description, severity
        const title = risk.title || risk.name || 'Risk';
        const description = risk.description || risk.details || '';
        const severity = risk.severity || risk.level || '';
        const severityBadge = severity ? `<span class="severity-badge severity-${severity.toLowerCase()}">${severity}</span>` : '';
        html += `<li><strong>${title}</strong> ${severityBadge}${description ? ': ' + description : ''}</li>`;
      } else {
        // Handle string format
        html += '<li>' + risk + '</li>';
      }
    });
    html += '</ul></div>';
  }
  
  html += '<details class="result-section"><summary>View Full JSON</summary><pre class="result-json">' + JSON.stringify(data, null, 2) + '</pre></details>';
  html += '<button onclick="copyResult()" class="copy-btn">üìã Copy Result</button></div>';
  
  container.innerHTML = html;
}

async function exportCSV() {
  if (!invoiceData || !invoiceData.tables || invoiceData.tables.length === 0) {
    alert("No invoice data to export. Please extract invoice data first.");
    return;
  }
  
  const table = invoiceData.tables[0];
  let csv = '';
  
  if (table.headers) {
    csv += table.headers.join(',') + '\n';
  }
  
  if (table.rows) {
    table.rows.forEach(row => {
      const values = table.headers.map(h => '"' + (row[h] || '') + '"');
      csv += values.join(',') + '\n';
    });
  }
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'invoice-export.csv';
  a.click();
}

function shareResult() {
  const shareUrl = window.location.href;
  if (navigator.share) {
    navigator.share({ title: "Invoice Analysis", url: shareUrl });
  } else {
    navigator.clipboard.writeText(shareUrl);
    alert("Link copied to clipboard!");
  }
}

function copyResult() {
  const results = document.querySelectorAll('.result-card pre');
  if (results.length > 0) {
    navigator.clipboard.writeText(results[0].innerText);
    alert("Results copied to clipboard!");
  }
}
</script>

<style>
.invoice-table {
  width: 100%;
  border-collapse: collapse;
  margin: 1rem 0;
}

.invoice-table th,
.invoice-table td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid #e0e0e0;
}

.invoice-table th {
  background: #f8f9ff;
  font-weight: 600;
  color: #6C5DD3;
}

.invoice-total {
  margin-top: 1rem;
  font-size: 1.25rem;
  color: #6C5DD3;
}

.severity-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
  margin-left: 0.5rem;
}

.severity-high {
  background: #fee;
  color: #c33;
  border: 1px solid #c33;
}

.severity-medium {
  background: #fff9e6;
  color: #b8860b;
  border: 1px solid #ffc107;
}

.severity-low {
  background: #e8f5e9;
  color: #2e7d32;
  border: 1px solid #4caf50;
}
</style>
{% endblock %}






