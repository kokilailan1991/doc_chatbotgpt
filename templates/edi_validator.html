{% extends "base.html" %}

{% block content %}
<div class="page-container">
  <div class="page-header">
    <h1>EDI Validator & Analyzer</h1>
    <p class="subtitle">Validate and analyze BAPLIE, MOVINS, COPRAR, and other EDI formats</p>
  </div>

  <div class="edi-container">
    <div class="upload-section">
      <h3>Upload EDI Document</h3>
      <form id="ediUploadForm" enctype="multipart/form-data">
        <input type="file" id="ediFile" accept=".pdf,.txt,.edi" />
        <button type="submit">Upload & Analyze</button>
      </form>
    </div>

    <div id="status" class="status-message"></div>
    <div id="results" class="results-container"></div>
  </div>
</div>

<script>
document.getElementById("ediUploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const file = document.getElementById("ediFile").files[0];
  if (!file) {
    document.getElementById("status").innerText = "Please select a file";
    return;
  }
  
  const formData = new FormData();
  formData.append("file", file);
  
  document.getElementById("status").innerText = "‚è≥ Analyzing EDI file...";
  document.getElementById("results").innerHTML = "";
  
  try {
    const res = await fetch("/api/analyze-edi", {
      method: "POST",
      body: formData
    });
    const data = await res.json();
    
    if (data.error) {
      document.getElementById("status").innerText = `‚ùå ${data.error}`;
    } else {
      document.getElementById("status").innerText = "‚úÖ EDI file analyzed successfully!";
      displayResults(data);
    }
  } catch (error) {
    document.getElementById("status").innerText = `‚ùå Error: ${error.message}`;
  }
});

function displayResults(data) {
  const container = document.getElementById("results");
  let html = '<div class="result-card fade-in"><h3 class="result-header">üìä EDI Analysis Results</h3>';
  
  const validation = data.validation || {};
  if (validation.isValid) {
    html += '<div class="result-section success-card"><h4>‚úÖ Validation: PASSED</h4></div>';
  } else {
    html += '<div class="result-section error-card"><h4>‚ùå Validation: FAILED</h4></div>';
  }
  
  if (validation.errors && validation.errors.length > 0) {
    html += '<div class="result-section error-card"><h4>‚ùå Errors:</h4><ul>';
    validation.errors.forEach(err => html += `<li>${err}</li>`);
    html += '</ul></div>';
  }
  
  if (validation.warnings && validation.warnings.length > 0) {
    html += '<div class="result-section warning-card"><h4>‚ö†Ô∏è Warnings:</h4><ul>';
    validation.warnings.forEach(warn => html += `<li>${warn}</li>`);
    html += '</ul></div>';
  }
  
  if (data.summary) {
    html += `<div class="result-section"><h4>üìù Summary:</h4><p>${data.summary}</p></div>`;
  }
  
  if (validation.containersFound > 0) {
    html += `<div class="result-section"><h4>üì¶ Containers Found: ${validation.containersFound}</h4></div>`;
  }
  
  html += `<details class="result-section"><summary>View Full JSON</summary><pre class="result-json">${JSON.stringify(data, null, 2)}</pre></details></div>`;
  
  container.innerHTML = html;
}
</script>
{% endblock %}







