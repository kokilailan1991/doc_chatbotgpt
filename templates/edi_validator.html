{% extends "base.html" %}

{% block content %}
<div class="page-container">
  <div class="page-header">
    <h1>EDI Validator & Analyzer</h1>
    <p class="subtitle">Validate and analyze BAPLIE, MOVINS, COPRAR, and other EDI formats</p>
  </div>

  <div class="edi-container">
    <div class="upload-section">
      <h3>Upload EDI Document</h3>
      <form id="ediUploadForm" enctype="multipart/form-data">
        <input type="file" id="ediFile" accept=".pdf,.txt,.edi" />
        <button type="submit">Upload & Analyze</button>
      </form>
    </div>

    <div id="status" class="status-message"></div>
    <div id="results" class="results-container"></div>
  </div>
</div>

<script>
document.getElementById("ediUploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData();
  formData.append("file", document.getElementById("ediFile").files[0]);
  
  const res = await fetch("/upload", { method: "POST", body: formData });
  const data = await res.json();
  document.getElementById("status").innerText = data.message || data.error;
  
  if (data.message) {
    const analysisRes = await fetch("/api/edi/analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    });
    const analysisData = await analysisRes.json();
    displayResults(analysisData);
  }
});

function displayResults(data) {
  const container = document.getElementById("results");
  container.innerHTML = `
    <div class="result-card">
      <h3>Analysis Results</h3>
      <div class="result-section">
        <h4>Format Type: ${data.formatType || 'Unknown'}</h4>
        <h4>Validation:</h4>
        <p>Valid: ${data.validation?.isValid ? 'Yes' : 'No'}</p>
        <p>Errors: ${JSON.stringify(data.validation?.errors || [])}</p>
        <p>Warnings: ${JSON.stringify(data.validation?.warnings || [])}</p>
      </div>
      <pre>${JSON.stringify(data, null, 2)}</pre>
    </div>
  `;
}
</script>
{% endblock %}


