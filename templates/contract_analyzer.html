{% extends "base.html" %}

{% block content %}
<div class="main-content-wrapper">
  <div class="tool-header">
    <h1 class="tool-title">üìú Contract Analyzer AI</h1>
    <p class="tool-subtitle">Professional contract analysis: obligations, risks, missing clauses, and legal insights. <strong style="color: #dc3545;">Informational only, not legal advice.</strong></p>
  </div>

  <button onclick="trySampleContract()" class="demo-btn-large">‚ú® Try Sample Contract</button>

  <div class="upload-card">
    <h3 class="upload-header">Upload Contract</h3>
    <form id="contractUploadForm" enctype="multipart/form-data">
      <label class="upload-label">Select Contract (PDF):</label>
      <input type="file" id="contractFile" accept=".pdf" class="file-input" />
      <button type="submit" class="upload-btn">Upload & Analyze</button>
    </form>
    
    <div class="sample-links">
      <a href="#" onclick="trySampleContract(); return false;">Try Sample Contract</a>
    </div>
  </div>

  <div id="contractStatus" class="status-message"></div>

  <div class="workflow-actions" id="contractActions" style="display: none;">
    <button onclick="analyzeContract()" class="workflow-btn">Analyze Contract</button>
    <button onclick="shareResult()" class="workflow-btn share">Share Result</button>
    <button onclick="copyResult()" class="workflow-btn copy">Copy Result</button>
  </div>

  <div id="contractResults" class="results-section"></div>
</div>

<script>
document.getElementById("contractUploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const file = document.getElementById("contractFile").files[0];
  if (!file) {
    document.getElementById("contractStatus").innerHTML = '<div class="error-message">Please select a PDF file</div>';
    return;
  }
  
  const formData = new FormData();
  formData.append("file", file);
  
  document.getElementById("contractStatus").innerHTML = '<div class="loading">‚è≥ Processing contract...</div>';
  
  try {
    const res = await fetch("/upload", { method: "POST", body: formData });
    
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}: ${res.statusText}` }));
      document.getElementById("contractStatus").innerHTML = '<div class="error-message">‚ùå ' + (errorData.error || `Server error: ${res.status}`) + '</div>';
      return;
    }
    
    const data = await res.json();
    
    if (data.error) {
      document.getElementById("contractStatus").innerHTML = '<div class="error-message">‚ùå ' + data.error + '</div>';
    } else if (data.message) {
      document.getElementById("contractStatus").innerHTML = '<div class="success-message">‚úÖ ' + data.message + '</div>';
      document.getElementById("contractActions").style.display = "flex";
    } else {
      document.getElementById("contractStatus").innerHTML = '<div class="error-message">‚ùå Unexpected response format</div>';
    }
  } catch (error) {
    document.getElementById("contractStatus").innerHTML = '<div class="error-message">‚ùå Error: ' + error.message + '</div>';
  }
});

async function analyzeContract() {
  const resultsDiv = document.getElementById("contractResults");
  resultsDiv.innerHTML = '<div class="loading">‚è≥ Analyzing contract... This should take 15-30 seconds.</div>';
  
  // Disable button during analysis
  const analyzeBtn = document.querySelector('button[onclick="analyzeContract()"]');
  const originalText = analyzeBtn ? analyzeBtn.textContent : '';
  if (analyzeBtn) {
    analyzeBtn.disabled = true;
    analyzeBtn.textContent = '‚è≥ Analyzing...';
  }
  
  try {
    const startTime = Date.now();
    const res = await fetch("/api/contract/analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    });
    
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}: ${res.statusText}` }));
      throw new Error(errorData.error || `Server error: ${res.status}`);
    }
    
    const data = await res.json();
    
    if (data.error) {
      document.getElementById("contractResults").innerHTML = '<div class="error-message">‚ùå ' + data.error + '</div>';
      return;
    }
    
    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
    displayContractResults("contractResults", data);
    document.getElementById("contractResults").scrollIntoView({ behavior: 'smooth' });
    
    // Re-enable button
    if (analyzeBtn) {
      analyzeBtn.disabled = false;
      analyzeBtn.textContent = originalText;
    }
  } catch (error) {
    document.getElementById("contractResults").innerHTML = '<div class="error-message">‚ùå Error: ' + error.message + '</div>';
    
    // Re-enable button on error
    if (analyzeBtn) {
      analyzeBtn.disabled = false;
      analyzeBtn.textContent = originalText;
    }
  }
}

async function trySampleContract() {
  const sampleData = {
    summary: "This Service Agreement outlines the terms and conditions between Allluminator Technologies Pvt Ltd and Horizon Logistics Ltd for the development and deployment of an AI-powered document analysis tool. The scope of work includes the development of the tool, maintenance and support for 12 months, and the delivery of weekly progress reports. The Provider will deliver a fully functional AI tool by 30 March 2025, along with documentation and training sessions for the Client's staff. The total contract value is USD 25,000, with a payment schedule of 40% upfront, 40% upon delivery of the beta version, and 20% after final acceptance.",
    metadata: {
      parties: { provider: "Allluminator Technologies Pvt Ltd", client: "Horizon Logistics Ltd" },
      contractDate: "2025-01-15",
      effectiveDate: "2025-01-15",
      expirationDate: "2026-01-15",
      contractValue: "USD 25,000",
      contractType: "Service Agreement",
      governingLaw: "Singapore",
      disputeResolution: "Arbitration in Singapore"
    },
    providerObligations: [
      { title: "Deliver AI Tool", description: "Deliver fully functional AI tool by 30 March 2025", deadline: "2025-03-30" },
      { title: "Provide Documentation", description: "Deliver complete documentation and training sessions", deadline: "Upon delivery" },
      { title: "Maintenance & Support", description: "Provide maintenance and support for 12 months", deadline: "Ongoing" }
    ],
    clientObligations: [
      { title: "Make Payments", description: "Pay 40% upfront, 40% upon beta delivery, 20% after final acceptance", deadline: "As per schedule" },
      { title: "Provide Access", description: "Provide necessary access and information for tool development", deadline: "Ongoing" }
    ],
    risks: [
      { title: "Broad Liability Clause", description: "Liability clause may be too broad and expose provider to excessive risk", severity: "high", category: "legal", mitigation: "Add liability cap and exclusions for indirect damages" },
      { title: "Unclear Termination Notice", description: "Termination clause lacks clear notice period", severity: "medium", category: "legal", mitigation: "Specify minimum 30-day written notice requirement" },
      { title: "Payment Risk", description: "20% payment after final acceptance may be delayed if acceptance criteria are unclear", severity: "medium", category: "financial", mitigation: "Define clear acceptance criteria and timeline" }
    ],
    missingClauses: [
      { clauseName: "Force Majeure", importance: "important", description: "Protects both parties from events beyond their control", suggestedWording: "Neither party shall be liable for delays due to circumstances beyond reasonable control." },
      { clauseName: "IP Ownership Clarification", importance: "critical", description: "Need clear IP ownership terms for developed tool", suggestedWording: "All IP rights in the developed tool shall belong to [specify party]." }
    ],
    keyClauses: {
      payment: "Payment schedule: 40% upfront, 40% upon beta delivery, 20% after final acceptance. Total value: USD 25,000.",
      confidentiality: "Both parties agree to maintain confidentiality of proprietary information for the duration and 3 years after termination.",
      liability: "Provider warrants services will be performed with reasonable skill and care. Liability limitations apply.",
      termination: "Agreement valid for 12 months. Termination provisions included but notice period could be clearer.",
      ipOwnership: "IP ownership terms need clarification - specify who owns the developed tool and any modifications.",
      disputeResolution: "Disputes to be resolved through arbitration in Singapore, governed by Singapore law.",
      warranties: "Provider warrants services will be performed with reasonable skill and care.",
      indemnification: "Standard indemnification clauses present but scope may need clarification."
    },
    improvements: [
      { title: "Clarify Termination Notice Period", description: "Add specific 30-day written notice requirement for termination", priority: "high", suggestedWording: "Either party may terminate this agreement with 30 days written notice." },
      { title: "Add Liability Cap", description: "Limit liability to contract value or a specified amount", priority: "high", suggestedWording: "Total liability shall not exceed the contract value of USD 25,000." },
      { title: "Define Acceptance Criteria", description: "Clearly define what constitutes 'final acceptance' to avoid payment delays", priority: "medium", suggestedWording: "Final acceptance shall be deemed granted if Client does not provide written objections within 14 days of delivery." }
    ],
    overallRiskLevel: "medium"
  };
  displayContractResults("contractResults", sampleData);
  document.getElementById("contractStatus").innerHTML = '<div class="success-message">‚úÖ Sample contract loaded!</div>';
  document.getElementById("contractActions").style.display = "flex";
}

function displayContractResults(containerId, data) {
  const container = document.getElementById(containerId);
  
  // Check for errors first
  if (data.error) {
    container.innerHTML = '<div class="error-message">‚ùå ' + data.error + '</div>';
    return;
  }
  
  let html = '<div class="result-card fade-in"><h3 class="result-header">üìú Contract Analysis</h3>';
  
  // Metadata Section
  if (data.metadata) {
    const meta = data.metadata;
    html += '<div class="result-section metadata-card"><h4>üìã Contract Metadata:</h4>';
    html += '<div class="metadata-grid">';
    if (meta.parties) {
      html += `<div class="metadata-item"><strong>Parties:</strong> ${meta.parties.provider || 'N/A'} (Provider) ‚Üî ${meta.parties.client || 'N/A'} (Client)</div>`;
    }
    if (meta.contractType) {
      html += `<div class="metadata-item"><strong>Type:</strong> ${meta.contractType}</div>`;
    }
    if (meta.contractValue) {
      html += `<div class="metadata-item"><strong>Value:</strong> ${meta.contractValue}</div>`;
    }
    if (meta.effectiveDate) {
      html += `<div class="metadata-item"><strong>Effective Date:</strong> ${meta.effectiveDate}</div>`;
    }
    if (meta.expirationDate) {
      html += `<div class="metadata-item"><strong>Expiration:</strong> ${meta.expirationDate}</div>`;
    }
    if (meta.governingLaw) {
      html += `<div class="metadata-item"><strong>Governing Law:</strong> ${meta.governingLaw}</div>`;
    }
    if (meta.disputeResolution) {
      html += `<div class="metadata-item"><strong>Dispute Resolution:</strong> ${meta.disputeResolution}</div>`;
    }
    html += '</div></div>';
  }
  
  // Summary Section
  if (data.summary) {
    html += '<div class="result-section summary-card"><h4>üìù Summary:</h4><p>' + data.summary + '</p></div>';
  }
  
  // Provider Obligations
  if (data.providerObligations && data.providerObligations.length > 0) {
    html += '<div class="result-section obligations-card provider"><h4>üë§ Provider Obligations:</h4><ul>';
    data.providerObligations.forEach(ob => {
      const title = typeof ob === 'object' ? (ob.title || 'Obligation') : ob;
      const desc = typeof ob === 'object' ? (ob.description || '') : '';
      const deadline = typeof ob === 'object' ? (ob.deadline ? ` <em>(Deadline: ${ob.deadline})</em>` : '') : '';
      html += `<li><strong>${title}</strong>${desc ? ': ' + desc : ''}${deadline}</li>`;
    });
    html += '</ul></div>';
  }
  
  // Client Obligations
  if (data.clientObligations && data.clientObligations.length > 0) {
    html += '<div class="result-section obligations-card client"><h4>üë• Client Obligations:</h4><ul>';
    data.clientObligations.forEach(ob => {
      const title = typeof ob === 'object' ? (ob.title || 'Obligation') : ob;
      const desc = typeof ob === 'object' ? (ob.description || '') : '';
      const deadline = typeof ob === 'object' ? (ob.deadline ? ` <em>(Deadline: ${ob.deadline})</em>` : '') : '';
      html += `<li><strong>${title}</strong>${desc ? ': ' + desc : ''}${deadline}</li>`;
    });
    html += '</ul></div>';
  }
  
  // Risks Section - Fixed to handle objects properly
  if (data.risks && data.risks.length > 0) {
    html += '<div class="result-section risks-card"><h4>‚ö†Ô∏è Risks & Red Flags:</h4>';
    if (data.overallRiskLevel) {
      const riskColor = data.overallRiskLevel === 'high' ? '#dc3545' : data.overallRiskLevel === 'medium' ? '#ffc107' : '#28a745';
      html += `<div class="overall-risk"><strong>Overall Risk Level:</strong> <span style="color: ${riskColor}; font-weight: bold;">${data.overallRiskLevel.toUpperCase()}</span></div>`;
    }
    html += '<ul>';
    data.risks.forEach(risk => {
      if (typeof risk === 'object' && risk !== null) {
        const title = risk.title || risk.name || 'Risk';
        const description = risk.description || risk.details || '';
        const severity = risk.severity || risk.level || '';
        const category = risk.category || '';
        const mitigation = risk.mitigation || '';
        const severityBadge = severity ? `<span class="severity-badge severity-${severity.toLowerCase()}">${severity.toUpperCase()}</span>` : '';
        const categoryBadge = category ? `<span class="category-badge">${category}</span>` : '';
        html += `<li><strong>${title}</strong> ${severityBadge} ${categoryBadge}`;
        if (description) {
          html += `<br>${description}`;
        }
        if (mitigation) {
          html += `<br><em style="color: #666;">üí° Mitigation: ${mitigation}</em>`;
        }
        html += '</li>';
      } else {
        html += '<li>' + risk + '</li>';
      }
    });
    html += '</ul></div>';
  }
  
  // Missing Clauses
  if (data.missingClauses && data.missingClauses.length > 0) {
    html += '<div class="result-section missing-clauses-card"><h4>‚ùå Missing Clauses:</h4><ul>';
    data.missingClauses.forEach(clause => {
      if (typeof clause === 'object' && clause !== null) {
        const name = clause.clauseName || clause.name || 'Clause';
        const importance = clause.importance || '';
        const description = clause.description || '';
        const wording = clause.suggestedWording || '';
        const importanceBadge = importance ? `<span class="importance-badge importance-${importance.toLowerCase()}">${importance}</span>` : '';
        html += `<li><strong>${name}</strong> ${importanceBadge}`;
        if (description) {
          html += `<br>${description}`;
        }
        if (wording) {
          html += `<br><em style="color: #666;">üí° Suggested: "${wording}"</em>`;
        }
        html += '</li>';
      } else {
        html += '<li>' + clause + '</li>';
      }
    });
    html += '</ul></div>';
  }
  
  // Key Clauses
  if (data.keyClauses && Object.keys(data.keyClauses).length > 0) {
    html += '<div class="result-section key-clauses-card"><h4>üîë Key Clauses:</h4>';
    html += '<div class="key-clauses-grid">';
    const clauseLabels = {
      payment: 'üí∞ Payment Terms',
      confidentiality: 'üîí Confidentiality',
      liability: '‚öñÔ∏è Liability',
      termination: 'üö™ Termination',
      ipOwnership: 'üìÑ IP Ownership',
      disputeResolution: '‚öñÔ∏è Dispute Resolution',
      warranties: '‚úÖ Warranties',
      indemnification: 'üõ°Ô∏è Indemnification'
    };
    Object.keys(data.keyClauses).forEach(key => {
      if (data.keyClauses[key]) {
        html += `<div class="key-clause-item"><strong>${clauseLabels[key] || key}:</strong> ${data.keyClauses[key]}</div>`;
      }
    });
    html += '</div></div>';
  }
  
  // Improvements
  if (data.improvements && data.improvements.length > 0) {
    html += '<div class="result-section improvements-card"><h4>üí° Suggested Improvements:</h4><ul>';
    data.improvements.forEach(imp => {
      if (typeof imp === 'object' && imp !== null) {
        const title = imp.title || imp.name || 'Improvement';
        const description = imp.description || '';
        const priority = imp.priority || '';
        const wording = imp.suggestedWording || '';
        const priorityBadge = priority ? `<span class="priority-badge priority-${priority.toLowerCase()}">${priority}</span>` : '';
        html += `<li><strong>${title}</strong> ${priorityBadge}`;
        if (description) {
          html += `<br>${description}`;
        }
        if (wording) {
          html += `<br><em style="color: #666;">üí° Suggested: "${wording}"</em>`;
        }
        html += '</li>';
      } else {
        html += '<li>' + imp + '</li>';
      }
    });
    html += '</ul></div>';
  }
  
  html += '<details class="result-section"><summary>View Full JSON</summary><pre class="result-json">' + JSON.stringify(data, null, 2) + '</pre></details>';
  html += '<button onclick="copyResult()" class="copy-btn">üìã Copy Result</button></div>';
  
  container.innerHTML = html;
}

function shareResult() {
  const shareUrl = window.location.href;
  if (navigator.share) {
    navigator.share({ title: "Contract Analysis", url: shareUrl });
  } else {
    navigator.clipboard.writeText(shareUrl);
    alert("Link copied to clipboard!");
  }
}

function copyResult() {
  const results = document.querySelectorAll('.result-card pre');
  if (results.length > 0) {
    navigator.clipboard.writeText(results[0].innerText);
    alert("Results copied to clipboard!");
  }
}
</script>

<style>
/* Contract-specific styles */
.metadata-card {
  background: linear-gradient(135deg, #E3F2FD 0%, #E8F5E9 100%);
  border-left: 4px solid #2196F3;
}

.metadata-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.metadata-item {
  padding: 0.75rem;
  background: white;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
}

.summary-card {
  background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%);
  border-left: 4px solid #9C27B0;
}

.obligations-card {
  border-left: 4px solid #4CAF50;
}

.obligations-card.provider {
  background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
}

.obligations-card.client {
  background: linear-gradient(135deg, #E1F5FE 0%, #B3E5FC 100%);
}

.risks-card {
  background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
  border-left: 4px solid #F44336;
}

.overall-risk {
  padding: 1rem;
  background: white;
  border-radius: 8px;
  margin-bottom: 1rem;
  font-size: 1.1rem;
}

.missing-clauses-card {
  background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
  border-left: 4px solid #FF9800;
}

.key-clauses-card {
  background: linear-gradient(135deg, #E0F2F1 0%, #B2DFDB 100%);
  border-left: 4px solid #009688;
}

.key-clauses-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.key-clause-item {
  padding: 1rem;
  background: white;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
  line-height: 1.6;
}

.improvements-card {
  background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
  border-left: 4px solid #4CAF50;
}

.severity-badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  margin-left: 0.5rem;
}

.severity-high {
  background: #ffebee;
  color: #c62828;
  border: 1px solid #c62828;
}

.severity-medium {
  background: #fff8e1;
  color: #f57c00;
  border: 1px solid #f57c00;
}

.severity-low {
  background: #e8f5e9;
  color: #2e7d32;
  border: 1px solid #2e7d32;
}

.category-badge {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 8px;
  font-size: 0.7rem;
  background: #e0e0e0;
  color: #424242;
  margin-left: 0.5rem;
}

.importance-badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  margin-left: 0.5rem;
}

.importance-critical {
  background: #ffebee;
  color: #c62828;
  border: 1px solid #c62828;
}

.importance-important {
  background: #fff8e1;
  color: #f57c00;
  border: 1px solid #f57c00;
}

.importance-recommended {
  background: #e8f5e9;
  color: #2e7d32;
  border: 1px solid #2e7d32;
}

.priority-badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  margin-left: 0.5rem;
}

.priority-high {
  background: #ffebee;
  color: #c62828;
  border: 1px solid #c62828;
}

.priority-medium {
  background: #fff8e1;
  color: #f57c00;
  border: 1px solid #f57c00;
}

.priority-low {
  background: #e8f5e9;
  color: #2e7d32;
  border: 1px solid #2e7d32;
}

.result-section ul li {
  margin: 0.75rem 0;
  line-height: 1.7;
}

.result-section ul li strong {
  color: #333;
}

@media (max-width: 768px) {
  .metadata-grid,
  .key-clauses-grid {
    grid-template-columns: 1fr;
  }
}
</style>
{% endblock %}
