{% extends "base.html" %}

{% block content %}
<div class="main-content-wrapper">
  <div class="tool-header">
    <h1 class="tool-title">üìú Contract Analyzer AI</h1>
    <p class="tool-subtitle">Analyze contracts for clauses, obligations, risks, and missing terms. <strong style="color: #dc3545;">Informational only, not legal advice.</strong></p>
  </div>

  <button onclick="trySampleContract()" class="demo-btn-large">‚ú® Try Sample Contract</button>

  <div class="upload-card">
    <h3 class="upload-header">Upload Contract</h3>
    <form id="contractUploadForm" enctype="multipart/form-data">
      <label class="upload-label">Select Contract (PDF):</label>
      <input type="file" id="contractFile" accept=".pdf" class="file-input" />
      <button type="submit" class="upload-btn">Upload & Analyze</button>
    </form>
    
    <div class="sample-links">
      <a href="#" onclick="trySampleContract(); return false;">Try Sample Contract</a>
    </div>
  </div>

  <div id="contractStatus" class="status-message"></div>

  <div class="workflow-actions" id="contractActions" style="display: none;">
    <button onclick="analyzeContract()" class="workflow-btn">Analyze Contract</button>
    <button onclick="shareResult()" class="workflow-btn share">Share Result</button>
    <button onclick="copyResult()" class="workflow-btn copy">Copy Result</button>
  </div>

  <div id="contractResults" class="results-section"></div>
</div>

<script>
document.getElementById("contractUploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const file = document.getElementById("contractFile").files[0];
  if (!file) {
    document.getElementById("contractStatus").innerHTML = '<div class="error-message">Please select a PDF file</div>';
    return;
  }
  
  const formData = new FormData();
  formData.append("file", file);
  
  document.getElementById("contractStatus").innerHTML = '<div class="loading">‚è≥ Processing contract...</div>';
  
  try {
    const res = await fetch("/upload", { method: "POST", body: formData });
    const data = await res.json();
    
    if (data.message) {
      document.getElementById("contractStatus").innerHTML = '<div class="success-message">‚úÖ ' + data.message + '</div>';
      document.getElementById("contractActions").style.display = "flex";
    } else {
      document.getElementById("contractStatus").innerHTML = '<div class="error-message">‚ùå ' + data.error + '</div>';
    }
  } catch (error) {
    document.getElementById("contractStatus").innerHTML = '<div class="error-message">‚ùå Error: ' + error.message + '</div>';
  }
});

async function analyzeContract() {
  document.getElementById("contractResults").innerHTML = '<div class="loading">‚è≥ Analyzing contract...</div>';
  try {
    const insightsRes = await fetch("/api/workflow/extract-insights", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ document_type: "contract" })
    });
    const insights = await insightsRes.json();
    
    const risksRes = await fetch("/api/workflow/risk-analysis", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    });
    const risks = await risksRes.json();
    
    const summaryRes = await fetch("/api/workflow/summary", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ type: "executive" })
    });
    const summary = await summaryRes.json();
    
    const data = {
      summary: summary.summary || "",
      obligations: insights.keyFindings || [],
      risks: risks.risks || [],
      missingClauses: insights.issues || [],
      improvements: insights.opportunities || []
    };
    
    displayContractResults("contractResults", data);
    document.getElementById("contractResults").scrollIntoView({ behavior: 'smooth' });
  } catch (error) {
    document.getElementById("contractResults").innerHTML = '<div class="error-message">‚ùå Error: ' + error.message + '</div>';
  }
}

async function trySampleContract() {
  const sampleData = {
    summary: "Sample service agreement between parties with standard terms and conditions.",
    obligations: [
      "Party A must deliver services within 30 days",
      "Party B must make payment within 15 days of invoice",
      "Both parties must maintain confidentiality"
    ],
    risks: [
      "Liability clause may be too broad",
      "Termination clause lacks clear notice period",
      "Dispute resolution mechanism not specified"
    ],
    missingClauses: [
      "Termination clause",
      "Liability limitation",
      "Confidentiality agreement",
      "Dispute resolution"
    ],
    improvements: [
      "Add specific termination notice period",
      "Clarify liability limitations",
      "Include dispute resolution mechanism",
      "Add force majeure clause"
    ]
  };
  displayContractResults("contractResults", sampleData);
  document.getElementById("contractStatus").innerHTML = '<div class="success-message">‚úÖ Sample contract loaded!</div>';
  document.getElementById("contractActions").style.display = "flex";
}

function displayContractResults(containerId, data) {
  const container = document.getElementById(containerId);
  let html = '<div class="result-card fade-in"><h3 class="result-header">üìú Contract Analysis</h3>';
  
  html += '<div class="result-section"><h4>üìù Summary:</h4><p>' + (data.summary || "No summary available") + '</p></div>';
  
  if (data.obligations && data.obligations.length > 0) {
    html += '<div class="result-section suggestion-card"><h4>üìã Obligations:</h4><ul>';
    data.obligations.forEach(ob => html += '<li>' + ob + '</li>');
    html += '</ul></div>';
  }
  
  if (data.risks && data.risks.length > 0) {
    html += '<div class="result-section error-card"><h4>‚ö†Ô∏è Risks:</h4><ul>';
    data.risks.forEach(risk => html += '<li>' + risk + '</li>');
    html += '</ul></div>';
  }
  
  if (data.missingClauses && data.missingClauses.length > 0) {
    html += '<div class="result-section warning-card"><h4>‚ùå Missing Clauses:</h4><ul>';
    data.missingClauses.forEach(clause => html += '<li>' + clause + '</li>');
    html += '</ul></div>';
  }
  
  if (data.improvements && data.improvements.length > 0) {
    html += '<div class="result-section suggestion-card"><h4>üí° Suggested Improvements:</h4><ul>';
    data.improvements.forEach(imp => html += '<li>' + imp + '</li>');
    html += '</ul></div>';
  }
  
  html += '<details class="result-section"><summary>View Full JSON</summary><pre class="result-json">' + JSON.stringify(data, null, 2) + '</pre></details>';
  html += '<button onclick="copyResult()" class="copy-btn">üìã Copy Result</button></div>';
  
  container.innerHTML = html;
}

function shareResult() {
  const shareUrl = window.location.href;
  if (navigator.share) {
    navigator.share({ title: "Contract Analysis", url: shareUrl });
  } else {
    navigator.clipboard.writeText(shareUrl);
    alert("Link copied to clipboard!");
  }
}

function copyResult() {
  const results = document.querySelectorAll('.result-card pre');
  if (results.length > 0) {
    navigator.clipboard.writeText(results[0].innerText);
    alert("Results copied to clipboard!");
  }
}
</script>
{% endblock %}

