{% extends "base.html" %}

{% block content %}
<div class="main-content-wrapper">
  <div class="tool-header">
    <h1 class="tool-title">üí∞ Salary Slip Analyzer</h1>
    <p class="tool-subtitle">Extract payroll data: Basic, HRA, PF, deductions, net pay. Find mistakes and tax flags.</p>
  </div>

  <button onclick="trySampleSalarySlip()" class="demo-btn-large">‚ú® Try Sample Salary Slip</button>

  <div class="upload-card">
    <h3 class="upload-header">Upload Salary Slip</h3>
    <form id="salaryUploadForm" enctype="multipart/form-data">
      <label class="upload-label">Select Salary Slip (PDF/Image):</label>
      <input type="file" id="salaryFile" accept=".pdf,.png,.jpg,.jpeg" class="file-input" />
      <button type="submit" class="upload-btn">Upload & Analyze</button>
    </form>
    
    <div class="sample-links">
      <a href="#" onclick="trySampleSalarySlip(); return false;">Try Sample Salary Slip</a>
    </div>
  </div>

  <div id="salaryStatus" class="status-message"></div>

  <div class="workflow-actions" id="salaryActions" style="display: none;">
    <button onclick="analyzeSalary()" class="workflow-btn">Analyze Payroll</button>
    <button onclick="shareResult()" class="workflow-btn share">Share Result</button>
    <button onclick="copyResult()" class="workflow-btn copy">Copy Result</button>
  </div>

  <div id="salaryResults" class="results-section"></div>
</div>

<script>
document.getElementById("salaryUploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const file = document.getElementById("salaryFile").files[0];
  if (!file) {
    document.getElementById("salaryStatus").innerHTML = '<div class="error-message">Please select a file</div>';
    return;
  }
  
  const formData = new FormData();
  formData.append("file", file);
  
  document.getElementById("salaryStatus").innerHTML = '<div class="loading">‚è≥ Processing salary slip...</div>';
  
  try {
    const res = await fetch("/upload", { method: "POST", body: formData });
    
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}: ${res.statusText}` }));
      document.getElementById("salaryStatus").innerHTML = '<div class="error-message">‚ùå ' + (errorData.error || `Server error: ${res.status}`) + '</div>';
      return;
    }
    
    const data = await res.json();
    
    if (data.error) {
      document.getElementById("salaryStatus").innerHTML = '<div class="error-message">‚ùå ' + data.error + '</div>';
    } else if (data.message) {
      document.getElementById("salaryStatus").innerHTML = '<div class="success-message">‚úÖ ' + data.message + '</div>';
      document.getElementById("salaryActions").style.display = "flex";
    } else {
      document.getElementById("salaryStatus").innerHTML = '<div class="error-message">‚ùå Unexpected response format</div>';
    }
  } catch (error) {
    document.getElementById("salaryStatus").innerHTML = '<div class="error-message">‚ùå Error: ' + error.message + '</div>';
  }
});

async function analyzeSalary() {
  document.getElementById("salaryResults").innerHTML = '<div class="loading">‚è≥ Analyzing salary slip...</div>';
  try {
    const res = await fetch("/api/business-docs/analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    });
    
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}: ${res.statusText}` }));
      throw new Error(errorData.error || `Server error: ${res.status}`);
    }
    
    const data = await res.json();
    
    if (data.error) {
      document.getElementById("salaryResults").innerHTML = '<div class="error-message">‚ùå ' + data.error + '</div>';
      return;
    }
    
    displaySalaryResults("salaryResults", data);
    document.getElementById("salaryResults").scrollIntoView({ behavior: 'smooth' });
  } catch (error) {
    document.getElementById("salaryResults").innerHTML = '<div class="error-message">‚ùå Error: ' + error.message + '</div>';
  }
}

async function trySampleSalarySlip() {
  const sampleData = {
    documentType: "Salary Slip",
    summary: "Salary slip for January 2024 showing earnings and deductions",
    tables: [{
      tableName: "Payroll Details",
      headers: ["Component", "Amount"],
      rows: [
        { Component: "Basic Salary", Amount: "‚Çπ50,000" },
        { Component: "HRA", Amount: "‚Çπ20,000" },
        { Component: "PF", Amount: "‚Çπ6,000" },
        { Component: "Tax Deduction", Amount: "‚Çπ5,000" },
        { Component: "Net Pay", Amount: "‚Çπ59,000" }
      ]
    }],
    risks: ["Verify PF calculation matches standard rate"],
    actionItems: ["Review tax deductions", "Confirm HRA calculation"]
  };
  displaySalaryResults("salaryResults", sampleData);
  document.getElementById("salaryStatus").innerHTML = '<div class="success-message">‚úÖ Sample salary slip loaded!</div>';
  document.getElementById("salaryActions").style.display = "flex";
}

function displaySalaryResults(containerId, data) {
  const container = document.getElementById(containerId);
  
  // Check for errors first
  if (data.error) {
    container.innerHTML = '<div class="error-message">‚ùå ' + data.error + '</div>';
    return;
  }
  
  let html = '<div class="result-card fade-in"><h3 class="result-header">üí∞ Salary Slip Analysis</h3>';
  
  if (data.summary) {
    html += '<div class="result-section"><h4>üìù Summary:</h4><p>' + data.summary + '</p></div>';
  }
  
  if (data.tables && data.tables.length > 0) {
    data.tables.forEach((table, idx) => {
      html += '<div class="result-section"><h4>üìä ' + (table.tableName || 'Payroll Table') + ':</h4>';
      if (table.headers && table.rows) {
        html += '<table class="invoice-table"><thead><tr>';
        table.headers.forEach(h => html += '<th>' + h + '</th>');
        html += '</tr></thead><tbody>';
        table.rows.forEach(row => {
          html += '<tr>';
          table.headers.forEach(h => html += '<td>' + (row[h] || '') + '</td>');
          html += '</tr>';
        });
        html += '</tbody></table>';
      }
      html += '</div>';
    });
  }
  
  if (data.risks && data.risks.length > 0) {
    html += '<div class="result-section error-card"><h4>‚ö†Ô∏è Tax-Related Flags:</h4><ul>';
    data.risks.forEach(risk => html += '<li>' + risk + '</li>');
    html += '</ul></div>';
  }
  
  if (data.actionItems && data.actionItems.length > 0) {
    html += '<div class="result-section warning-card"><h4>üîç Mistake Finder:</h4><ul>';
    data.actionItems.forEach(item => html += '<li>' + item + '</li>');
    html += '</ul></div>';
  }
  
  html += '<details class="result-section"><summary>View Full JSON</summary><pre class="result-json">' + JSON.stringify(data, null, 2) + '</pre></details>';
  html += '<button onclick="copyResult()" class="copy-btn">üìã Copy Result</button></div>';
  
  container.innerHTML = html;
}

function shareResult() {
  const shareUrl = window.location.href;
  if (navigator.share) {
    navigator.share({ title: "Salary Slip Analysis", url: shareUrl });
  } else {
    navigator.clipboard.writeText(shareUrl);
    alert("Link copied to clipboard!");
  }
}

function copyResult() {
  const results = document.querySelectorAll('.result-card pre');
  if (results.length > 0) {
    navigator.clipboard.writeText(results[0].innerText);
    alert("Results copied to clipboard!");
  }
}
</script>
{% endblock %}






