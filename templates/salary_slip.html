{% extends "base.html" %}

{% block content %}
<div class="main-content-wrapper">
  <div class="tool-header">
    <h1 class="tool-title">üí∞ Salary Slip Analyzer</h1>
    <p class="tool-subtitle">Professional payroll analysis: extract data, find tax flags, detect mistakes, and get SIP planning recommendations.</p>
  </div>

  <button onclick="trySampleSalarySlip()" class="demo-btn-large">‚ú® Try Sample Salary Slip</button>

  <div class="upload-card">
    <h3 class="upload-header">Upload Salary Slip</h3>
    <form id="salaryUploadForm" enctype="multipart/form-data">
      <label class="upload-label">Select Salary Slip (PDF/Image):</label>
      <input type="file" id="salaryFile" accept=".pdf,.png,.jpg,.jpeg" class="file-input" />
      <button type="submit" class="upload-btn">Upload & Analyze</button>
    </form>
    
    <div class="sample-links">
      <a href="#" onclick="trySampleSalarySlip(); return false;">Try Sample Salary Slip</a>
    </div>
  </div>

  <div id="salaryStatus" class="status-message"></div>

  <div class="workflow-actions" id="salaryActions" style="display: none;">
    <button onclick="analyzeSalary()" class="workflow-btn">Analyze Payroll</button>
    <button onclick="shareResult()" class="workflow-btn share">Share Result</button>
    <button onclick="copyResult()" class="workflow-btn copy">Copy Result</button>
  </div>

  <div id="salaryResults" class="results-section"></div>
</div>

<script>
document.getElementById("salaryUploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const file = document.getElementById("salaryFile").files[0];
  if (!file) {
    document.getElementById("salaryStatus").innerHTML = '<div class="error-message">Please select a file</div>';
    return;
  }
  
  const formData = new FormData();
  formData.append("file", file);
  
  document.getElementById("salaryStatus").innerHTML = '<div class="loading">‚è≥ Processing salary slip...</div>';
  
  try {
    const res = await fetch("/upload", { method: "POST", body: formData });
    
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}: ${res.statusText}` }));
      document.getElementById("salaryStatus").innerHTML = '<div class="error-message">‚ùå ' + (errorData.error || `Server error: ${res.status}`) + '</div>';
      return;
    }
    
    const data = await res.json();
    
    if (data.error) {
      document.getElementById("salaryStatus").innerHTML = '<div class="error-message">‚ùå ' + data.error + '</div>';
    } else if (data.message) {
      document.getElementById("salaryStatus").innerHTML = '<div class="success-message">‚úÖ ' + data.message + '</div>';
      document.getElementById("salaryActions").style.display = "flex";
    } else {
      document.getElementById("salaryStatus").innerHTML = '<div class="error-message">‚ùå Unexpected response format</div>';
    }
  } catch (error) {
    document.getElementById("salaryStatus").innerHTML = '<div class="error-message">‚ùå Error: ' + error.message + '</div>';
  }
});

async function analyzeSalary() {
  document.getElementById("salaryResults").innerHTML = '<div class="loading">‚è≥ Analyzing salary slip... This may take a minute.</div>';
  try {
    const res = await fetch("/api/salary-slip/analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    });
    
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}: ${res.statusText}` }));
      throw new Error(errorData.error || `Server error: ${res.status}`);
    }
    
    const data = await res.json();
    
    if (data.error) {
      document.getElementById("salaryResults").innerHTML = '<div class="error-message">‚ùå ' + data.error + '</div>';
      return;
    }
    
    displaySalaryResults("salaryResults", data);
    document.getElementById("salaryResults").scrollIntoView({ behavior: 'smooth' });
  } catch (error) {
    document.getElementById("salaryResults").innerHTML = '<div class="error-message">‚ùå Error: ' + error.message + '</div>';
  }
}

async function trySampleSalarySlip() {
  const sampleData = {
    summary: "Salary slip for January 2024 showing gross salary of ‚Çπ75,000 with standard deductions for PF, tax, and insurance. Net pay is ‚Çπ59,000.",
    salaryData: [
      { component: "Basic Salary", amount: "‚Çπ50,000" },
      { component: "HRA", amount: "‚Çπ20,000" },
      { component: "Special Allowance", amount: "‚Çπ5,000" },
      { component: "Total Earnings", amount: "‚Çπ75,000" }
    ],
    expensesData: [
      { component: "PF (Provident Fund)", amount: "‚Çπ6,000" },
      { component: "Tax Deduction (TDS)", amount: "‚Çπ5,000" },
      { component: "Insurance", amount: "‚Çπ2,000" },
      { component: "Other Deductions", amount: "‚Çπ3,000" },
      { component: "Total Deductions", amount: "‚Çπ16,000" }
    ],
    taxFlags: [
      { title: "HRA Exemption Opportunity", message: "You may be eligible for HRA exemption if you're paying rent. Provide rent receipts to maximize tax savings." },
      { title: "Section 80C Optimization", message: "Consider investing in ELSS or PPF to maximize Section 80C deductions and reduce tax liability." }
    ],
    mistakes: [
      { title: "PF Calculation Verification", message: "PF deduction (‚Çπ6,000) should be verified against standard 12% of Basic Salary. Expected: ‚Çπ6,000 (12% of ‚Çπ50,000)." },
      { title: "Tax Deduction Review", message: "TDS of ‚Çπ5,000 seems high. Review tax calculations and ensure all exemptions are properly declared." }
    ],
    savingsSuggestions: [
      "Consider investing in ELSS (Equity Linked Savings Scheme) for tax benefits under Section 80C",
      "Maximize HRA exemption by providing rent receipts if applicable",
      "Consider investing 20-30% of net salary (‚Çπ14,750) in SIP for long-term wealth creation",
      "Review and optimize tax deductions to maximize take-home salary"
    ],
    sipPlanning: {
      recommendedMonthlySIP: 14750,
      expectedReturns: {
        "3years": { invested: 531000, returns: 108000, total: 639000 },
        "5years": { invested: 885000, returns: 245000, total: 1130000 },
        "10years": { invested: 1770000, returns: 785000, total: 2555000 }
      },
      investmentCategories: [
        { category: "Large Cap Funds", allocation: "40%", amount: 5900, description: "Stable, established companies" },
        { category: "Mid Cap Funds", allocation: "30%", amount: 4425, description: "Growth potential with moderate risk" },
        { category: "Small Cap Funds", allocation: "20%", amount: 2950, description: "High growth potential, higher risk" },
        { category: "Debt Funds", allocation: "10%", amount: 1475, description: "Stability and liquidity" }
      ]
    }
  };
  displaySalaryResults("salaryResults", sampleData);
  document.getElementById("salaryStatus").innerHTML = '<div class="success-message">‚úÖ Sample salary slip loaded!</div>';
  document.getElementById("salaryActions").style.display = "flex";
}

function displaySalaryResults(containerId, data) {
  const container = document.getElementById(containerId);
  
  // Check for errors first
  if (data.error) {
    container.innerHTML = '<div class="error-message">‚ùå ' + data.error + '</div>';
    return;
  }
  
  let html = '<div class="result-card fade-in"><h3 class="result-header">üí∞ Salary Slip Analysis</h3>';
  
  // Summary Section
  if (data.summary) {
    html += '<div class="result-section summary-card"><h4>üìù Summary:</h4><p>' + data.summary + '</p></div>';
  }
  
  // Salary Data Table
  if (data.salaryData && data.salaryData.length > 0) {
    html += '<div class="result-section salary-data-card"><h4>üí∞ Salary/Earnings:</h4>';
    html += '<table class="salary-table"><thead><tr><th>Component</th><th>Amount</th></tr></thead><tbody>';
    let totalEarnings = 0;
    data.salaryData.forEach(item => {
      const component = typeof item === 'object' ? (item.component || item.name || '') : item;
      const amount = typeof item === 'object' ? (item.amount || '') : '';
      if (amount) {
        const numAmount = parseFloat(amount.replace(/[‚Çπ,$,\s]/g, '')) || 0;
        totalEarnings += numAmount;
      }
      html += `<tr><td>${component}</td><td>${amount}</td></tr>`;
    });
    html += `<tr class="total-row"><td><strong>Total Earnings</strong></td><td><strong>‚Çπ${totalEarnings.toLocaleString('en-IN')}</strong></td></tr>`;
    html += '</tbody></table></div>';
  }
  
  // Expenses/Deductions Table
  if (data.expensesData && data.expensesData.length > 0) {
    html += '<div class="result-section expenses-data-card"><h4>üìâ Deductions/Expenses:</h4>';
    html += '<table class="salary-table"><thead><tr><th>Component</th><th>Amount</th></tr></thead><tbody>';
    let totalDeductions = 0;
    data.expensesData.forEach(item => {
      const component = typeof item === 'object' ? (item.component || item.name || '') : item;
      const amount = typeof item === 'object' ? (item.amount || '') : '';
      if (amount) {
        const numAmount = parseFloat(amount.replace(/[‚Çπ,$,\s]/g, '')) || 0;
        totalDeductions += numAmount;
      }
      html += `<tr><td>${component}</td><td>${amount}</td></tr>`;
    });
    html += `<tr class="total-row"><td><strong>Total Deductions</strong></td><td><strong>‚Çπ${totalDeductions.toLocaleString('en-IN')}</strong></td></tr>`;
    html += '</tbody></table></div>';
    
    // Calculate and show Net Pay
    const netPay = totalEarnings - totalDeductions;
    if (netPay > 0) {
      html += `<div class="result-section net-pay-card"><h4>üíµ Net Pay:</h4><p class="net-pay-amount">‚Çπ${netPay.toLocaleString('en-IN')}</p></div>`;
    }
  }
  
  // Tax Flags - FIXED to handle objects properly
  if (data.taxFlags && data.taxFlags.length > 0) {
    html += '<div class="result-section tax-flags-card"><h4>‚ö†Ô∏è Tax-Related Flags:</h4><ul>';
    data.taxFlags.forEach(flag => {
      if (typeof flag === 'object' && flag !== null) {
        const title = flag.title || flag.name || 'Tax Flag';
        const message = flag.message || flag.description || flag.details || '';
        html += `<li><strong>${title}</strong>${message ? ': ' + message : ''}</li>`;
      } else {
        html += '<li>' + flag + '</li>';
      }
    });
    html += '</ul></div>';
  }
  
  // Mistakes - FIXED to handle objects properly
  if (data.mistakes && data.mistakes.length > 0) {
    html += '<div class="result-section mistakes-card"><h4>üîç Mistake Finder:</h4><ul>';
    data.mistakes.forEach(mistake => {
      if (typeof mistake === 'object' && mistake !== null) {
        const title = mistake.title || mistake.name || 'Mistake';
        const message = mistake.message || mistake.description || mistake.details || '';
        html += `<li><strong>${title}</strong>${message ? ': ' + message : ''}</li>`;
      } else {
        html += '<li>' + mistake + '</li>';
      }
    });
    html += '</ul></div>';
  }
  
  // Savings Suggestions
  if (data.savingsSuggestions && data.savingsSuggestions.length > 0) {
    html += '<div class="result-section savings-card"><h4>üí° Recommended Savings Suggestions:</h4><ul>';
    data.savingsSuggestions.forEach(suggestion => {
      html += '<li>' + suggestion + '</li>';
    });
    html += '</ul></div>';
  }
  
  // SIP Planning Section
  if (data.sipPlanning && data.sipPlanning.recommendedMonthlySIP > 0) {
    const sip = data.sipPlanning;
    html += '<div class="result-section sip-planning-card"><h4>üìà SIP Planning Recommendations:</h4>';
    html += `<div class="sip-summary"><p class="sip-amount"><strong>Recommended Monthly SIP:</strong> ‚Çπ${sip.recommendedMonthlySIP.toLocaleString('en-IN')}</p></div>`;
    
    if (sip.expectedReturns) {
      html += '<div class="sip-returns"><h5>Expected Returns (12% annual return):</h5>';
      html += '<div class="returns-grid">';
      
      if (sip.expectedReturns["3years"]) {
        const r3 = sip.expectedReturns["3years"];
        html += `<div class="return-item"><strong>3 Years:</strong><br>Invested: ‚Çπ${r3.invested.toLocaleString('en-IN')}<br>Returns: ‚Çπ${r3.returns.toLocaleString('en-IN')}<br>Total: ‚Çπ${r3.total.toLocaleString('en-IN')}</div>`;
      }
      if (sip.expectedReturns["5years"]) {
        const r5 = sip.expectedReturns["5years"];
        html += `<div class="return-item"><strong>5 Years:</strong><br>Invested: ‚Çπ${r5.invested.toLocaleString('en-IN')}<br>Returns: ‚Çπ${r5.returns.toLocaleString('en-IN')}<br>Total: ‚Çπ${r5.total.toLocaleString('en-IN')}</div>`;
      }
      if (sip.expectedReturns["10years"]) {
        const r10 = sip.expectedReturns["10years"];
        html += `<div class="return-item"><strong>10 Years:</strong><br>Invested: ‚Çπ${r10.invested.toLocaleString('en-IN')}<br>Returns: ‚Çπ${r10.returns.toLocaleString('en-IN')}<br>Total: ‚Çπ${r10.total.toLocaleString('en-IN')}</div>`;
      }
      html += '</div></div>';
    }
    
    if (sip.investmentCategories && sip.investmentCategories.length > 0) {
      html += '<div class="sip-categories"><h5>Recommended Investment Categories:</h5><ul>';
      sip.investmentCategories.forEach(cat => {
        html += `<li><strong>${cat.category}</strong> (${cat.allocation}) - ‚Çπ${cat.amount.toLocaleString('en-IN')}/month<br><em>${cat.description}</em></li>`;
      });
      html += '</ul></div>';
    }
    
    html += '</div>';
  }
  
  html += '<details class="result-section"><summary>View Full JSON</summary><pre class="result-json">' + JSON.stringify(data, null, 2) + '</pre></details>';
  html += '<button onclick="copyResult()" class="copy-btn">üìã Copy Result</button></div>';
  
  container.innerHTML = html;
}

function shareResult() {
  const shareUrl = window.location.href;
  if (navigator.share) {
    navigator.share({ title: "Salary Slip Analysis", url: shareUrl });
  } else {
    navigator.clipboard.writeText(shareUrl);
    alert("Link copied to clipboard!");
  }
}

function copyResult() {
  const results = document.querySelectorAll('.result-card pre');
  if (results.length > 0) {
    navigator.clipboard.writeText(results[0].innerText);
    alert("Results copied to clipboard!");
  }
}
</script>

<style>
/* Salary Slip specific styles */
.summary-card {
  background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
  border-left: 4px solid #2196F3;
}

.salary-data-card {
  background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
  border-left: 4px solid #4CAF50;
}

.expenses-data-card {
  background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
  border-left: 4px solid #FF9800;
}

.net-pay-card {
  background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%);
  border-left: 4px solid #9C27B0;
  text-align: center;
}

.net-pay-amount {
  font-size: 2rem;
  font-weight: bold;
  color: #9C27B0;
  margin: 1rem 0;
}

.tax-flags-card {
  background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
  border-left: 4px solid #F44336;
}

.mistakes-card {
  background: linear-gradient(135deg, #FFF9C4 0%, #FFF59D 100%);
  border-left: 4px solid #FBC02D;
}

.savings-card {
  background: linear-gradient(135deg, #E0F2F1 0%, #B2DFDB 100%);
  border-left: 4px solid #009688;
}

.sip-planning-card {
  background: linear-gradient(135deg, #E8EAF6 0%, #C5CAE9 100%);
  border-left: 4px solid #3F51B5;
}

.salary-table {
  width: 100%;
  border-collapse: collapse;
  margin: 1rem 0;
}

.salary-table th,
.salary-table td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid #e0e0e0;
}

.salary-table th {
  background: rgba(255, 255, 255, 0.5);
  font-weight: 600;
  color: #333;
}

.salary-table .total-row {
  background: rgba(255, 255, 255, 0.7);
  border-top: 2px solid #333;
}

.sip-summary {
  padding: 1rem;
  background: white;
  border-radius: 8px;
  margin: 1rem 0;
}

.sip-amount {
  font-size: 1.25rem;
  color: #3F51B5;
  margin: 0;
}

.sip-returns {
  margin: 1.5rem 0;
}

.sip-returns h5 {
  margin-bottom: 1rem;
  color: #333;
}

.returns-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.return-item {
  padding: 1rem;
  background: white;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
  line-height: 1.8;
}

.sip-categories {
  margin-top: 1.5rem;
}

.sip-categories h5 {
  margin-bottom: 1rem;
  color: #333;
}

.sip-categories ul li {
  margin: 1rem 0;
  line-height: 1.8;
}

@media (max-width: 768px) {
  .returns-grid {
    grid-template-columns: 1fr;
  }
  
  .net-pay-amount {
    font-size: 1.5rem;
  }
}
</style>
{% endblock %}
