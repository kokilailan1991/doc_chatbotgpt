{% extends "base.html" %}

{% block content %}
<div class="page-container">
  <div class="page-header">
    <h1>Resume Analyzer</h1>
    <p class="subtitle">Get ATS Score, Match with Job Descriptions, and Improve Your Resume</p>
  </div>

  <div class="resume-analyzer-container">
    <div class="upload-section">
      <h3>Upload Your Resume</h3>
      <form id="resumeUploadForm" enctype="multipart/form-data">
        <input type="file" id="resumeFile" accept=".pdf" />
        <button type="submit">Upload Resume</button>
      </form>

      <h3 style="margin-top: 30px;">Upload Job Description (Optional)</h3>
      <form id="jdUploadForm" enctype="multipart/form-data">
        <input type="file" id="jdFile" accept=".pdf" />
        <button type="submit">Upload JD</button>
      </form>
    </div>

    <div id="status" class="status-message"></div>

    <div class="analysis-actions" id="actions" style="display: none;">
      <button onclick="getATSScore()" class="action-btn primary">Get ATS Score</button>
      <button onclick="matchWithJD()" class="action-btn primary">Match with JD</button>
      <button onclick="getFullReport()" class="action-btn primary">Full Report</button>
      <button onclick="rewriteResume()" class="action-btn secondary">Rewrite Resume</button>
    </div>

    <div id="results" class="results-container"></div>
  </div>
</div>

<script>
document.getElementById("resumeUploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData();
  formData.append("file", document.getElementById("resumeFile").files[0]);
  formData.append("file_id", "active");
  
  try {
    const res = await fetch("/api/upload-multi", { method: "POST", body: formData });
    
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}: ${res.statusText}` }));
      document.getElementById("status").innerText = "❌ " + (errorData.error || `Server error: ${res.status}`);
      return;
    }
    
    const data = await res.json();
    
    if (data.error) {
      document.getElementById("status").innerText = "❌ " + data.error;
    } else if (data.message) {
      document.getElementById("status").innerText = "✅ " + data.message;
      document.getElementById("actions").style.display = "block";
    } else {
      document.getElementById("status").innerText = "❌ Unexpected response format";
    }
  } catch (error) {
    document.getElementById("status").innerText = "❌ Error: " + error.message;
  }
});

document.getElementById("jdUploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData();
  formData.append("file", document.getElementById("jdFile").files[0]);
  formData.append("file_id", "jd");
  
  try {
    const res = await fetch("/api/upload-multi", { method: "POST", body: formData });
    
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}: ${res.statusText}` }));
      document.getElementById("status").innerText += "\n❌ " + (errorData.error || `Server error: ${res.status}`);
      return;
    }
    
    const data = await res.json();
    
    if (data.error) {
      document.getElementById("status").innerText += "\n❌ " + data.error;
    } else if (data.message) {
      document.getElementById("status").innerText += "\n✅ " + data.message;
    } else {
      document.getElementById("status").innerText += "\n❌ Unexpected response format";
    }
  } catch (error) {
    document.getElementById("status").innerText += "\n❌ Error: " + error.message;
  }
});

async function getATSScore() {
  try {
    const res = await fetch("/api/resume/ats-score", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({})
    });
    
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}: ${res.statusText}` }));
      displayResults({ error: errorData.error || `Server error: ${res.status}` });
      return;
    }
    
    const data = await res.json();
    
    if (data.error) {
      displayResults({ error: data.error });
    } else {
      displayResults(data);
    }
  } catch (error) {
    displayResults({ error: error.message });
  }
}

async function matchWithJD() {
  try {
    const res = await fetch("/api/resume/match-jd", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ jd_file_id: "jd" })
    });
    
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}: ${res.statusText}` }));
      displayResults({ error: errorData.error || `Server error: ${res.status}` });
      return;
    }
    
    const data = await res.json();
    
    if (data.error) {
      displayResults({ error: data.error });
    } else {
      displayResults(data);
    }
  } catch (error) {
    displayResults({ error: error.message });
  }
}

async function getFullReport() {
  try {
    const res = await fetch("/api/resume/full-report", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ jd_file_id: "jd" })
    });
    
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}: ${res.statusText}` }));
      displayResults({ error: errorData.error || `Server error: ${res.status}` });
      return;
    }
    
    const data = await res.json();
    
    if (data.error) {
      displayResults({ error: data.error });
    } else {
      displayResults(data);
    }
  } catch (error) {
    displayResults({ error: error.message });
  }
}

async function rewriteResume() {
  try {
    const res = await fetch("/api/resume/rewrite", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ improvements: [] })
    });
    
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}: ${res.statusText}` }));
      displayResults({ error: errorData.error || `Server error: ${res.status}` });
      return;
    }
    
    const data = await res.json();
    
    if (data.error) {
      displayResults({ error: data.error });
    } else {
      displayResults(data);
    }
  } catch (error) {
    displayResults({ error: error.message });
  }
}

function displayResults(data) {
  const container = document.getElementById("results");
  
  if (data.error) {
    container.innerHTML = `<div class="error-message">❌ ${data.error}</div>`;
  } else {
    container.innerHTML = `<div class="result-card"><pre>${JSON.stringify(data, null, 2)}</pre></div>`;
  }
}
</script>
{% endblock %}







